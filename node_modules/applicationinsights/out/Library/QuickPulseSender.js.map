{"version":3,"file":"QuickPulseSender.js","sourceRoot":"","sources":["../../Library/QuickPulseSender.ts"],"names":[],"mappings":"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","sourcesContent":["import https = require(\"https\");\nimport Config = require(\"./Config\");\nimport AutoCollectHttpDependencies = require(\"../AutoCollection/HttpDependencies\");\nimport Logging = require(\"./Logging\");\nimport QuickPulseUtil = require(\"./QuickPulseUtil\");\nimport Util = require(\"./Util\");\n\n// Types\nimport * as http from \"http\";\nimport * as Contracts from \"../Declarations/Contracts\";\n\nconst QuickPulseConfig = {\n    method: \"POST\",\n    time: \"x-ms-qps-transmission-time\",\n    subscribed: \"x-ms-qps-subscribed\"\n};\n\nclass QuickPulseSender {\n    private static TAG = \"QuickPulseSender\";\n    private static MAX_QPS_FAILURES_BEFORE_WARN = 25;\n\n    private _config: Config;\n    private _consecutiveErrors: number;\n\n    constructor(config: Config) {\n        this._config = config;\n        this._consecutiveErrors = 0;\n    }\n\n    public ping(envelope: Contracts.EnvelopeQuickPulse, done: (shouldPOST?: boolean, res?: http.IncomingMessage) => void): void {\n        this._submitData(envelope, done, \"ping\");\n    }\n\n    public post(envelope: Contracts.EnvelopeQuickPulse, done: (shouldPOST?: boolean, res?: http.IncomingMessage) => void): void {\n\n        // Important: When POSTing data, envelope must be an array\n        this._submitData([envelope], done, \"post\");\n    }\n\n    private _submitData(envelope: Contracts.EnvelopeQuickPulse | Contracts.EnvelopeQuickPulse[], done: (shouldPOST?: boolean, res?: http.IncomingMessage) => void, postOrPing: \"post\" | \"ping\"): void {\n        const payload = JSON.stringify(envelope);\n        var options = {\n            [AutoCollectHttpDependencies.disableCollectionRequestOption]: true,\n            host: this._config.quickPulseHost,\n            method: QuickPulseConfig.method,\n            path: `/QuickPulseService.svc/${postOrPing}?ikey=${this._config.instrumentationKey}`,\n            headers:{\n                'Expect': '100-continue',\n                [QuickPulseConfig.time]: QuickPulseUtil.getTransmissionTime(), // unit = 100s of nanoseconds\n                'Content-Type': 'application\\/json',\n                'Content-Length': Buffer.byteLength(payload)\n            }\n        };\n\n        // HTTPS only\n        if (this._config.httpsAgent) {\n            (<any>options).agent = this._config.httpsAgent;\n        } else {\n            (<any>options).agent = Util.tlsRestrictedAgent;\n        }\n\n        const req = https.request(options, (res: http.IncomingMessage) => {\n            const shouldPOSTData = res.headers[QuickPulseConfig.subscribed] === \"true\";\n            this._consecutiveErrors = 0;\n            done(shouldPOSTData, res);\n        });\n        req.on(\"error\", (error: Error) => {\n            // Unable to contact qps endpoint.\n            // Do nothing for now.\n            this._consecutiveErrors++;\n\n            // LOG every error, but WARN instead when X number of consecutive errors occur\n            let notice = `Transient error connecting to the Live Metrics endpoint. This packet will not appear in your Live Metrics Stream. Error:`;\n            if (this._consecutiveErrors % QuickPulseSender.MAX_QPS_FAILURES_BEFORE_WARN === 0) {\n                notice = `Live Metrics endpoint could not be reached ${this._consecutiveErrors} consecutive times. Most recent error:`;\n                Logging.warn(QuickPulseSender.TAG, notice, error);\n            } else {\n                // Potentially transient error, do not change the ping/post state yet.\n                Logging.info(QuickPulseSender.TAG, notice, error);\n            }\n\n            done();\n        });\n\n        req.write(payload);\n        req.end();\n    }\n}\n\nexport = QuickPulseSender;\n"]}