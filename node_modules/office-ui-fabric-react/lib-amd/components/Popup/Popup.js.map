{"version":3,"file":"Popup.js","sourceRoot":"../src/","sources":["components/Popup/Popup.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport {\n  Async,\n  KeyCodes,\n  divProperties,\n  doesElementContainFocus,\n  getDocument,\n  getNativeProps,\n  on,\n  getWindow,\n  elementContains,\n} from '../../Utilities';\nimport { IPopupProps } from './Popup.types';\n\nexport interface IPopupState {\n  needsVerticalScrollBar?: boolean;\n}\n\n/**\n * This adds accessibility to Dialog and Panel controls\n */\nexport class Popup extends React.Component<IPopupProps, IPopupState> {\n  public static defaultProps: IPopupProps = {\n    shouldRestoreFocus: true,\n  };\n\n  public _root = React.createRef<HTMLDivElement>();\n  private _disposables: (() => void)[] = [];\n  private _originalFocusedElement: HTMLElement;\n  private _containsFocus: boolean;\n  private _async: Async;\n\n  public constructor(props: IPopupProps) {\n    super(props);\n    this._async = new Async(this);\n    this.state = { needsVerticalScrollBar: false };\n  }\n\n  public UNSAFE_componentWillMount(): void {\n    this._originalFocusedElement = getDocument()!.activeElement as HTMLElement;\n  }\n\n  public componentDidMount(): void {\n    if (this._root.current) {\n      this._disposables.push(\n        on(this._root.current, 'focus', this._onFocus, true),\n        on(this._root.current, 'blur', this._onBlur, true),\n      );\n      const currentWindow = getWindow(this._root.current);\n      if (currentWindow) {\n        this._disposables.push(on(currentWindow, 'keydown', this._onKeyDown as any));\n      }\n      if (doesElementContainFocus(this._root.current)) {\n        this._containsFocus = true;\n      }\n    }\n\n    this._updateScrollBarAsync();\n  }\n\n  public componentDidUpdate() {\n    this._updateScrollBarAsync();\n    this._async.dispose();\n  }\n\n  public componentWillUnmount(): void {\n    this._disposables.forEach((dispose: () => void) => dispose());\n\n    // eslint-disable-next-line deprecation/deprecation\n    if (this.props.shouldRestoreFocus) {\n      const { onRestoreFocus = defaultFocusRestorer } = this.props;\n      onRestoreFocus({\n        originalElement: this._originalFocusedElement,\n        containsFocus: this._containsFocus,\n        documentContainsFocus: getDocument()?.hasFocus() || false,\n      });\n    }\n    // De-reference DOM Node to avoid retainment via transpiled closure of _onKeyDown\n    delete this._originalFocusedElement;\n  }\n\n  public render(): JSX.Element {\n    const { role, className, ariaLabel, ariaLabelledBy, ariaDescribedBy, style } = this.props;\n\n    return (\n      <div\n        ref={this._root}\n        {...getNativeProps(this.props, divProperties)}\n        className={className}\n        role={role}\n        aria-label={ariaLabel}\n        aria-labelledby={ariaLabelledBy}\n        aria-describedby={ariaDescribedBy}\n        onKeyDown={this._onKeyDown}\n        style={{ overflowY: this.state.needsVerticalScrollBar ? 'scroll' : undefined, outline: 'none', ...style }}\n      >\n        {this.props.children}\n      </div>\n    );\n  }\n\n  private _onKeyDown = (ev: React.KeyboardEvent<HTMLElement>): void => {\n    switch (ev.which) {\n      case KeyCodes.escape:\n        if (this.props.onDismiss) {\n          this.props.onDismiss(ev);\n\n          ev.preventDefault();\n          ev.stopPropagation();\n        }\n\n        break;\n    }\n  };\n\n  private _updateScrollBarAsync(): void {\n    this._async.requestAnimationFrame(() => {\n      this._getScrollBar();\n    });\n  }\n\n  private _getScrollBar(): void {\n    // If overflowY is overriden, don't waste time calculating whether the scrollbar is necessary.\n    if (this.props.style && this.props.style.overflowY) {\n      return;\n    }\n\n    let needsVerticalScrollBar = false;\n    if (this._root && this._root.current && this._root.current.firstElementChild) {\n      // ClientHeight returns the client height of an element rounded to an\n      // integer. On some browsers at different zoom levels this rounding\n      // can generate different results for the root container and child even\n      // though they are the same height. This causes us to show a scroll bar\n      // when not needed. Ideally we would use BoundingClientRect().height\n      // instead however seems that the API is 90% slower than using ClientHeight.\n      // Therefore instead we will calculate the difference between heights and\n      // allow for a 1px difference to still be considered ok and not show the\n      // scroll bar.\n      const rootHeight = this._root.current.clientHeight;\n      const firstChildHeight = this._root.current.firstElementChild.clientHeight;\n      if (rootHeight > 0 && firstChildHeight > rootHeight) {\n        needsVerticalScrollBar = firstChildHeight - rootHeight > 1;\n      }\n    }\n    if (this.state.needsVerticalScrollBar !== needsVerticalScrollBar) {\n      this.setState({\n        needsVerticalScrollBar: needsVerticalScrollBar,\n      });\n    }\n  }\n\n  private _onFocus = (): void => {\n    this._containsFocus = true;\n  };\n\n  private _onBlur = (ev: FocusEvent): void => {\n    /** The popup should update this._containsFocus when:\n     * relatedTarget exists AND\n     * the relatedTarget is not contained within the popup.\n     * If the relatedTarget is within the popup, that means the popup still has focus\n     * and focused moved from one element to another within the popup.\n     * If relatedTarget is undefined or null that usually means that a\n     * keyboard event occured and focus didn't change\n     */\n    if (\n      this._root.current &&\n      ev.relatedTarget &&\n      !elementContains(this._root.current, ev.relatedTarget as HTMLElement)\n    ) {\n      this._containsFocus = false;\n    }\n  };\n}\n\nfunction defaultFocusRestorer(options: {\n  originalElement?: HTMLElement | Window;\n  containsFocus: boolean;\n  documentContainsFocus: boolean;\n}) {\n  const { originalElement, containsFocus } = options;\n\n  if (originalElement && containsFocus && originalElement !== window) {\n    // Make sure that the focus method actually exists\n    // In some cases the object might exist but not be a real element.\n    // This is primarily for IE 11 and should be removed once IE 11 is no longer in use.\n    if (originalElement.focus) {\n      originalElement.focus();\n    }\n  }\n}\n"]}